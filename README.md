# unidbg-trace-tools

Unidbg Trace Viewer 可视化与分析工具（Python 3.8 / PyQt5）。

## 安装

```bash
python3.8 -m pip install -U pip
python3.8 -m pip install -e .
```

或直接在源码下运行（无需安装）：

```bash
python3.8 -m trace_viewer.app /path/to/trace.txt
```

已提供脚本入口：

```bash
trace-viewer /path/to/trace.txt
```

## 主要功能

- 三联动视图：函数列表 / 代码窗口 / 寄存器窗口
- 代码行前缀显示时间戳与 PC 地址，便于定位第几次运行
- 点击函数或代码中的地址即可跳转并同步寄存器
- 值流追踪面板（异步，不阻塞 UI）
  - 支持按寄存器、地址、地址范围检索读/写事件
  - 值匹配：执行前 / 执行后 / 任意（十六进制）
  - 追踪值路径：基于倒排索引快速构建寄存器值来源→使用链路
  - 右键“指定值追踪”同样异步，候选唯一自动进入
- 右键“指定值追踪”：在代码视图选中行，右键选择寄存器并填写值（如 `0xfffffffb`），直接得到该值的链路
- 内存写入对比：预计算有效地址 + 地址→store 索引，显示字节差异
- 全寄存器状态：寄存器表始终显示全部寄存器，并对被追踪的寄存器行高亮

## 使用流程

1. 从 Unidbg 侧导出 trace 文本（例如 `fanqie_trace.txt`）
2. 运行本工具并打开该文件（大文件首次解析会自动构建索引）
3. 在值流追踪输入寄存器（如 `r1`）与可选筛选条件，点击“搜索”
4. 如需定位某个具体值，填写“值匹配”后点击“追踪值路径”，或在代码窗口右键→指定值追踪
5. 在结果列表单击/双击行即可跳转，右侧寄存器表会展示该行 before/after 的完整状态

## 快捷键

- 增大/减小代码字体：`Ctrl+=` / `Ctrl+-`

## 兼容性

- Python ≥ 3.8
- PyQt5 ≥ 5.15.2

## 注意

- 不提交大型样本与缓存：`.trace_cache/`、`.venv/`、`*.mdc` 已被忽略。
- 若右键追踪候选较多，优先选择与当前行同 `call_id` 且最近的候选能显著提速。

## 功能展示

- 异步值流追踪：
  - 右侧“值流追踪”与代码窗口右键“指定值追踪”均在后台线程计算，界面不会卡顿。
  - 候选唯一时自动进入链路，结果列表可双击跳转对应事件。
- 伪C代码导出：
  - 在值流结果列表中选中多行，点击“导出伪C代码”，生成包含 `uint32_t` 寄存器声明与 `replay()` 函数的简洁 C 表达式序列（覆盖 and/eor/orr/mvn/add/sub/mov 与 lsl/lsr）。
- 寄存器/汇编高亮：
  - 助记符、寄存器、立即数/地址、注释分色显示；被追踪寄存器在寄存器表中整行高亮，变化后的值背景强调。
- 内存写入对比：
  - 自动识别 `str*/ldr*`，显示写入前/后的字节；不同字节高亮，未知值显示为“(未知)”。
- 快速定位与导航：
  - 顶部地址栏跳转 `0x...`，函数列表内置“函数候选”（分支目标集合），代码窗口内地址可点击跳转。

